<!DOCTYPE html>
<html lang="zh-CN" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画师 Prompt 管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'PingFang SC', 'Microsoft YaHei', 'sans-serif'],
                    },
                    transitionTimingFunction: {
                        'ios': 'cubic-bezier(0.25, 0.1, 0.25, 1.0)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* 核心布局：禁止 Body 滚动，由内部容器接管 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            background: linear-gradient(135deg, #e0e7ff, #f3e8ff, #fce7f3);
            color: #1e293b;
        }
        .dark body {
            background: linear-gradient(135deg, #0f172a, #1e1b4b, #312e81);
            color: #f8fafc;
        }

        #app {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        /* 美化滚动条 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.4); border-radius: 999px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        /* 毛玻璃效果组件 */
        .glass-header { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); }
        .dark .glass-header { background: rgba(15, 23, 42, 0.65); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }

        .glass-sidebar { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(16px); border-left: 1px solid rgba(255, 255, 255, 0.5); border-radius: 1.5rem; }
        .dark .glass-sidebar { background: rgba(15, 23, 42, 0.75); border-left: 1px solid rgba(255, 255, 255, 0.05); }

        .glass-card { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .dark .glass-card { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.3); }

        .glass-modal { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
        .dark .glass-modal { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* 布局系统 */
        .app-layout { display: flex; flex-grow: 1; overflow: hidden; padding: 1.5rem; gap: 1.5rem; }
        .golden-ratio-main { flex: 1; min-width: 400px; overflow-y: auto; }
        .sidebar-container { width: 360px; flex-shrink: 0; display: flex; flex-direction: column; }
        
        .btn-icon { transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1.0); }
        .btn-icon:active { transform: scale(0.92); }

        @media (max-width: 1024px) {
            .app-layout { padding: 1rem; gap: 1rem; }
            .sidebar-container { width: 300px; }
        }
        @media (max-width: 768px) { 
            .app-layout { padding: 0.5rem; display: block; }
            .sidebar-container { display: none; } 
        }

        /* === 主题样式 === */
        body { transition: background 0.5s ease, color 0.3s ease; }
        body.theme-light { background: linear-gradient(135deg, #e0e7ff, #f3e8ff, #fce7f3); color: #1e293b; }
        body.theme-dark { background: linear-gradient(135deg, #0f172a, #1e1b4b, #312e81); color: #f8fafc; }
        body.theme-midnight { background: linear-gradient(135deg, #020617, #111827, #0f172a); color: #e2e8f0; }
        body.theme-sakura { background: linear-gradient(135deg, #fff1f2, #ffe4e6, #fecdd3); color: #881337; }
        body.theme-ocean { background: linear-gradient(135deg, #ecfeff, #cffafe, #a5f3fc); color: #164e63; }
    </style>
</head>
<body>

    <div id="app" class="w-full h-full transition-colors duration-300"></div>
    <div id="modal-container"></div>
    <div id="ai-settings-container"></div>
    <div id="toast-container" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100]"></div>
    <div id="preview-modal-container"></div>
    
    <script>
        // =========================================
        // 1. 数据存储层 (IndexedDB for Images)
        // =========================================
        const DB_NAME = 'NAIArtistDB';
        const STORE_NAME = 'images';
        const METADATA_KEY = 'nai-artists-metadata'; 
        const THEME_KEY = 'nai-theme-preference';
        const AI_CONFIG_KEY = 'nai-ai-config';
        const DISPLAY_CONFIG_KEY = 'nai-display-config';

        // 数据库操作封装
        const openDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onerror = () => reject('DB Error');
            request.onsuccess = (e) => resolve(e.target.result);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };
        });

        const saveImageToIDB = async (id, base64Data) => {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).put({ id, base64Data });
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            } catch (e) { console.error("IDB Save Error", e); }
        };

        const getAllImagesFromIDB = async () => {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readonly');
                    const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = () => resolve(req.result.reduce((acc, item) => {
                        acc[item.id] = item.base64Data;
                        return acc;
                    }, {}));
                    req.onerror = () => resolve({});
                });
            } catch (e) { return {}; }
        };

        const deleteImageFromIDB = async (id) => {
            try {
                const db = await openDB();
                return new Promise((resolve) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    tx.objectStore(STORE_NAME).delete(id);
                    tx.oncomplete = () => resolve();
                });
            } catch (e) { console.error("IDB Delete Error", e); }
        };

        // =========================================
        // 2. Utilities & Theme
        // =========================================
        const showToast = (message) => {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const el = document.createElement('div');
            el.className = "bg-slate-800/90 dark:bg-white/90 backdrop-blur-md text-white dark:text-slate-900 px-6 py-3 rounded-full shadow-xl animate-fade-in font-medium text-sm flex items-center gap-2 mb-2";
            el.innerHTML = `<i data-lucide="${message.includes('复制') ? 'copy' : 'check-circle'}" class="w-4 h-4"></i> ${message}`;
            container.appendChild(el);
            lucide.createIcons(el);
            setTimeout(() => { if (container.contains(el)) container.removeChild(el); }, 2500);
        };

        const readImageAsBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        const themes = {
            light: { name: '浅色', icon: 'sun', isDark: false },
            dark: { name: '深色', icon: 'moon', isDark: true },
            midnight: { name: '午夜', icon: 'star', isDark: true },
            sakura: { name: '樱花', icon: 'flower-2', isDark: false },
            ocean: { name: '海洋', icon: 'droplets', isDark: false }
        };

        const applyTheme = (themeMode) => {
            const mode = themeMode || state.theme;
            const themeConfig = themes[mode] || themes.light;
            
            document.body.classList.remove(...Object.keys(themes).map(k => `theme-${k}`));
            document.body.classList.add(`theme-${mode}`);
            
            if (themeConfig.isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };

        // =========================================
        // 3. State & Business Logic
        // =========================================
        const INITIAL_DATA = [
            { id: '1', name: 'Mika Pikazo', tag: 'mika pikazo', imageUrl: 'https://placehold.co/600x400/818CF8/FFFFFF?text=Mika', isFavorite: true, createdAt: 1700000000000, danbooruCount: 1500, isNSFW: false },
            { id: '2', name: 'Wlop', tag: 'wlop', imageUrl: 'https://placehold.co/600x400/6366F1/FFFFFF?text=Wlop', isFavorite: false, createdAt: 1700000000001, danbooruCount: 800, isNSFW: false },
            { id: '3', name: 'Kantoku', tag: 'kantoku', imageUrl: 'https://placehold.co/600x400/EC4899/FFFFFF?text=Kantoku', isFavorite: true, createdAt: 1700000000002, danbooruCount: 4200, isNSFW: false },
            { id: '4', name: 'Carmine', tag: 'carmine', imageUrl: '', isFavorite: false, createdAt: 1700000000003, danbooruCount: 200, isNSFW: false }
        ];

        let state = {
            liveArtists: [],
            selectedArtists: {}, 
            searchQuery: '',
            sortMode: 'default', 
            isDataLoading: true,
            isModalOpen: false,
            editingArtist: null,
            previewImage: null,
            showThemeMenu: false,
            formData: { name: '', tag: '', imageUrl: '', danbooruCount: 0, isNSFW: false },
            theme: localStorage.getItem(THEME_KEY) || 'light',
            aiConfig: JSON.parse(localStorage.getItem(AI_CONFIG_KEY) || '{}'),
            displayConfig: JSON.parse(localStorage.getItem(DISPLAY_CONFIG_KEY) || '{"showCardInfo": false, "blurNSFW": true}'),
            isAISettingsOpen: false
        };

        const updateState = (newState, shouldRender = true) => {
            const oldSort = state.sortMode;
            state = { ...state, ...newState };
            
            if (!state.isDataLoading && newState.liveArtists) {
                const metadata = state.liveArtists.map(a => {
                    const { imageUrl, ...rest } = a;
                    const safeUrl = (imageUrl && imageUrl.startsWith('data:')) ? '' : imageUrl;
                    return { ...rest, imageUrl: safeUrl };
                });
                try { localStorage.setItem(METADATA_KEY, JSON.stringify(metadata)); } catch(e) {}
            }
            
            if (newState.theme) {
                localStorage.setItem(THEME_KEY, newState.theme);
                applyTheme(newState.theme);
            }

            if (shouldRender) {
                const fullRender = newState.liveArtists || newState.searchQuery !== undefined || (newState.sortMode && newState.sortMode !== oldSort) || newState.theme;
        if (fullRender) {
                    renderApp(); 
                } else {
                    if (newState.selectedArtists) {
                        renderArtistCards(); 
                        renderSelectionArea(); 
                    }
                    if (newState.isModalOpen !== undefined || newState.isAISettingsOpen !== undefined) renderModals();
                    if (newState.previewImage !== undefined) renderModals();
                    if (newState.showThemeMenu !== undefined) renderThemeMenu();
                }
            }
        };

        // --- Global Actions ---
        window.toggleThemeMenu = () => updateState({ showThemeMenu: !state.showThemeMenu });
        
        window.setTheme = (themeName) => {
            updateState({ theme: themeName, showThemeMenu: false });
        };

        window.handleSearch = (val) => updateState({ searchQuery: val });

        window.setSortMode = (newMode) => {
            let finalMode = newMode;
            if (newMode === 'alpha') finalMode = state.sortMode === 'alpha-asc' ? 'alpha-desc' : 'alpha-asc';
            if (newMode === 'danbooru') finalMode = state.sortMode === 'danbooru-desc' ? 'danbooru-asc' : 'danbooru-desc';
            updateState({ sortMode: finalMode });
        };

        window.clearSelection = () => updateState({ selectedArtists: {} });
        window.toggleSelection = (id) => {
            const newSel = { ...state.selectedArtists };
            if (newSel[id]) delete newSel[id]; else newSel[id] = 1.0;
            updateState({ selectedArtists: newSel });
        };
        window.updateArtistWeight = (id, delta, e) => {
            e.stopPropagation();
            const curr = state.selectedArtists[id] || 1.0;
            let next = parseFloat((curr + delta).toFixed(1));
            if (next < 0.1) next = 0.1; if (next > 2.0) next = 2.0;
            updateState({ selectedArtists: { ...state.selectedArtists, [id]: next } }, false);
            renderSelectionArea();
        };
        window.toggleFavorite = (id, e) => {
            e.stopPropagation();
            const newArtists = state.liveArtists.map(a => a.id === id ? { ...a, isFavorite: !a.isFavorite } : a);
            updateState({ liveArtists: newArtists });
        };
        window.handleCardAction = (id, action, e) => {
            e.stopPropagation(); 
            if (action === 'delete') {
                if (confirm('确定删除此画师吗？')) {
                    deleteImageFromIDB(id).then(() => {
                        const newArtists = state.liveArtists.filter(a => a.id !== id);
                        const newSel = { ...state.selectedArtists };
                        delete newSel[id];
                        updateState({ liveArtists: newArtists, selectedArtists: newSel });
                        showToast('已删除');
                    });
                }
            } else if (action === 'edit') {
                const artist = state.liveArtists.find(a => a.id === id);
                if (artist) {
                    state.formData = { ...artist }; 
                    updateState({ isModalOpen: true, editingArtist: artist, previewImage: null });
                }
            } else if (action === 'preview') {
                const artist = state.liveArtists.find(a => a.id === id);
                if (artist) updateState({ previewImage: artist.imageUrl });
            }
        };
        
        // 修复：使用 execCommand 来兼容 iframe 环境
        window.copyPrompts = () => {
            const list = getSelectedList();
            const text = list.map(a => a.weight === 1.0 ? a.tag : `(${a.tag}:${a.weight.toFixed(1)})`).join(', ');
            
            // 创建临时 textarea 进行复制
            const textArea = document.createElement("textarea");
            textArea.value = text;
            // 确保元素不可见但存在
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    showToast('已复制 Prompt');
                } else {
                    showToast('复制失败');
                }
            } catch (err) {
                showToast('复制失败');
            }
            
            document.body.removeChild(textArea);
        };

        window.copyTag = (id, e) => {
            e.stopPropagation();
            const artist = state.liveArtists.find(a => a.id === id);
            if (!artist) return;
            
            const textArea = document.createElement("textarea");
            textArea.value = artist.tag;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    showToast(`已复制: ${artist.tag}`);
                } else {
                    showToast('复制失败');
                }
            } catch (err) {
                showToast('复制失败');
            }
            
            document.body.removeChild(textArea);
        };

        // --- Import / Export ---
        window.handleExport = async () => {
            const imageMap = await getAllImagesFromIDB();
            const fullData = state.liveArtists.map(a => ({ ...a, imageUrl: imageMap[a.id] || a.imageUrl || '' }));
            const jsonStr = JSON.stringify(fullData, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `nai_artists_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast('数据已导出');
        };
        window.triggerImport = () => document.getElementById('import-file-input').click();
        window.handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const rawJson = JSON.parse(ev.target.result);
                    let importList = [];

                    // 智能识别旧格式
                    if (rawJson && typeof rawJson === 'object' && !Array.isArray(rawJson) && Array.isArray(rawJson.artists)) {
                        importList = rawJson.artists.map(item => ({
                            id: String(item.id || Date.now() + Math.random()),
                            name: item.name || 'Unknown',
                            tag: item.name || 'unknown', 
                            imageUrl: item.image || '', 
                            danbooruCount: parseInt(item.count) || 0, 
                            isFavorite: false,
                            isNSFW: false,
                            createdAt: item.time ? new Date(item.time).getTime() : Date.now()
                        }));
                    } else if (Array.isArray(rawJson)) {
                        importList = rawJson;
                    } else {
                        throw new Error('Unknown JSON format');
                    }

                    const currentTags = new Set(state.liveArtists.map(a => a.tag));
                    const newArtists = [...state.liveArtists];
                    let addedCount = 0;

                    for (const item of importList) {
                        if (currentTags.has(item.tag)) continue; 

                        const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        if (item.imageUrl && item.imageUrl.startsWith('data:')) {
                            await saveImageToIDB(id, item.imageUrl);
                        }

                        newArtists.push({
                            id: id,
                            name: item.name || item.tag,
                            tag: item.tag,
                            imageUrl: item.imageUrl || '',
                            danbooruCount: parseInt(item.danbooruCount) || 0,
                            isFavorite: !!item.isFavorite,
                            isNSFW: !!item.isNSFW,
                            createdAt: item.createdAt || Date.now()
                        });
                        currentTags.add(item.tag);
                        addedCount++;
                    }

                    updateState({ liveArtists: newArtists });
                    showToast(addedCount > 0 ? `成功导入 ${addedCount} 位画师` : '未发现新数据 (重复数据)');
                } catch (err) { showToast('导入失败: 格式错误'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        // --- Modal Logic ---
        window.openAddModal = () => {
            state.formData = { name: '', tag: '', imageUrl: '', danbooruCount: 0, isNSFW: false };
            updateState({ isModalOpen: true, editingArtist: null, previewImage: null });
        };
        window.handleCloseModal = () => updateState({ isModalOpen: false, editingArtist: null, previewImage: null });

        window.handleModalFormInput = (field, value) => {
            state.formData[field] = value;
            if (field === 'tag') {
                const btn = document.getElementById('modal-save-btn');
                if (btn) {
                    if (value.trim()) {
                        btn.removeAttribute('disabled');
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        btn.setAttribute('disabled', 'true');
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }
        };
        window.handleModalFileSelect = async (e) => {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            try {
                const base64 = await readImageAsBase64(file);
                state.formData.imageUrl = base64;
                updateModalImagePreviewDOM(); 
                showToast('图片已添加');
            } catch(e) { showToast('图片读取失败'); }
            e.target.value = '';
        };
        window.handleModalRemoveImage = (e) => {
            e.stopPropagation();
            state.formData.imageUrl = '';
            updateModalImagePreviewDOM();
        };
        const updateModalImagePreviewDOM = () => {
            const container = document.getElementById('image-upload-container');
            if (!container) return;
            if (state.formData.imageUrl) {
                container.innerHTML = `
                    <div class="relative w-full h-36 rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-700 group shadow-sm">
                        <img src="${state.formData.imageUrl}" class="w-full h-full object-cover" />
                        <button onclick="handleModalRemoveImage(event)" class="absolute top-2 right-2 bg-black/60 text-white p-2 rounded-full hover:bg-red-500 transition-colors shadow-md btn-icon"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="w-full h-36 border-2 border-dashed border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800/50 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors group btn-icon" onclick="document.getElementById('modal-file-input').click()">
                        <i data-lucide="image-plus" class="w-8 h-8 text-slate-400 group-hover:text-indigo-500 transition-colors mb-2"></i>
                        <p class="text-xs font-medium text-slate-500 group-hover:text-indigo-500">点击上传图片</p>
                    </div>`;
            }
            lucide.createIcons(container);
        };
        window.handleSaveArtist = async () => {
            const { name, tag, imageUrl, danbooruCount, isNSFW } = state.formData;
            if (!tag || !tag.trim()) return;
            const isEdit = !!state.editingArtist;
            const id = isEdit ? state.editingArtist.id : Date.now().toString();
            if (imageUrl && imageUrl.startsWith('data:')) await saveImageToIDB(id, imageUrl);
            else if (isEdit && !imageUrl) await deleteImageFromIDB(id);
            
            const artistData = {
                id, name: name || tag, tag: tag.trim(), imageUrl: imageUrl, 
                danbooruCount: parseInt(danbooruCount) || 0,
                isNSFW: !!isNSFW,
                isFavorite: isEdit ? state.editingArtist.isFavorite : false,
                createdAt: isEdit ? state.editingArtist.createdAt : Date.now(),
            };
            
            let newArtists;
            if (isEdit) {
                newArtists = state.liveArtists.map(a => a.id === id ? artistData : a);
                showToast('已更新');
            } else {
                newArtists = [artistData, ...state.liveArtists];
                showToast('已添加');
            }

            updateState({ liveArtists: newArtists, isModalOpen: false, editingArtist: null });
        };
        window.closePreview = () => updateState({ previewImage: null });

        // --- AI Configuration & Logic ---
        window.openAISettings = () => updateState({ isAISettingsOpen: true });
        window.closeAISettings = () => updateState({ isAISettingsOpen: false });
        window.saveAISettings = () => {
             const apiHost = (document.getElementById('ai-host-input').value || 'https://api.openai.com/v1').replace(/\/+$/, '');
             const apiKey = document.getElementById('ai-key-input').value.trim();
             const model = document.getElementById('ai-model-input').value.trim() || 'gpt-4o';
             const showCardInfo = document.getElementById('show-card-info-toggle').checked;
             const blurNSFW = document.getElementById('blur-nsfw-toggle').checked;
             
             const newConfig = { apiHost, apiKey, model };
             const newDisplayConfig = { showCardInfo, blurNSFW };
             updateState({ aiConfig: newConfig, displayConfig: newDisplayConfig, isAISettingsOpen: false });
             localStorage.setItem(AI_CONFIG_KEY, JSON.stringify(newConfig));
             localStorage.setItem(DISPLAY_CONFIG_KEY, JSON.stringify(newDisplayConfig));
             showToast('设置已保存');
        };

        window.analyzeArtistStyle = async () => {
            const { imageUrl } = state.formData;
            const config = state.aiConfig || {};
            
            if (!imageUrl) { showToast('请先上传图片'); return; }
            if (!config.apiKey) { showToast('请先配置 AI Key'); window.openAISettings(); return; }

            const btn = document.getElementById('analyze-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
            btn.disabled = true;

            try {
                const response = await fetch(`${config.apiHost}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            {
                                role: "user",
                                content: [
                                    { type: "text", text: "请分析这张图片的画风，并用精准的六个中文字符总结（例如：'赛博朋克霓虹'、'厚涂油画质感'）。请直接返回这六个字，不要包含任何标点或其他内容。" },
                                    { type: "image_url", image_url: { url: imageUrl } }
                                ]
                            }
                        ],
                        max_tokens: 50
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || response.statusText);
                }

                const data = await response.json();
                const content = data.choices[0].message.content.trim();
                const cleanContent = content.replace(/[^\u4e00-\u9fa5]/g, '').slice(0, 6); // Extract first 6 Chinese chars

                if (cleanContent) {
                    state.formData.name = cleanContent;
                    const nameInput = document.getElementById('modal-artist-name');
                    if (nameInput) nameInput.value = cleanContent;
                    showToast(`分析成功: ${cleanContent}`);
                } else {
                    showToast('分析结果为空');
                }
            } catch (error) {
                console.error('AI Analysis Error:', error);
                showToast(`分析失败: ${error.message}`);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                lucide.createIcons(btn);
            }
        };

        // =========================================
        // 5. Rendering
        // =========================================
        const getSelectedList = () => Object.keys(state.selectedArtists).map(id => {
            const a = state.liveArtists.find(x => x.id === id);
            return a ? { ...a, weight: state.selectedArtists[id] } : null;
        }).filter(Boolean);

        const renderApp = () => {
            const app = document.getElementById('app');
            if (!app.hasChildNodes()) {
                app.innerHTML = `
                    <header class="h-20 px-6 flex items-center justify-between glass-header z-20 flex-shrink-0 transition-colors duration-300">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
                                <span class="text-white font-bold text-xl">N</span>
                            </div>
                            <h1 class="text-xl font-bold tracking-tight text-slate-800 dark:text-white">画师 Prompt <span class="text-indigo-600 dark:text-indigo-400">管理器</span></h1>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="relative hidden md:block group">
                                <i data-lucide="search" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                                <input type="text" placeholder="搜索画师..." value="${state.searchQuery}" oninput="handleSearch(this.value)" 
                                    class="pl-12 pr-4 py-3 bg-white/50 dark:bg-slate-800/50 border border-white/60 dark:border-slate-700 rounded-2xl text-base focus:outline-none focus:ring-2 focus:ring-indigo-400/50 w-72 transition-all text-slate-800 dark:text-slate-100 placeholder-slate-500" />
                            </div>
                            
                            <!-- AI Settings -->
                            <button onclick="openAISettings()" title="AI设置" class="btn-icon p-3 rounded-full bg-white dark:bg-slate-800 hover:bg-indigo-50 dark:hover:bg-slate-700 shadow-lg border border-white/10 text-slate-700 dark:text-slate-200">
                                <i data-lucide="settings" class="w-6 h-6 text-indigo-500"></i>
                            </button>

                            <!-- Theme Toggle -->
                            <div class="relative">
                                <button onclick="toggleThemeMenu()" title="切换主题" class="btn-icon p-3 rounded-full bg-white dark:bg-slate-800 hover:bg-indigo-50 dark:hover:bg-slate-700 shadow-lg border border-white/10 text-slate-700 dark:text-slate-200">
                                    <i data-lucide="palette" class="w-6 h-6 text-indigo-500"></i>
                                </button>
                                <div id="theme-menu" class="hidden"></div>
                            </div>

                            <div class="h-8 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                            <button onclick="triggerImport()" title="导入 JSON" class="btn-icon p-3 rounded-full bg-white dark:bg-slate-800 hover:bg-indigo-50 dark:hover:bg-slate-700 shadow-lg border border-white/10 text-indigo-600 dark:text-indigo-400">
                                <i data-lucide="arrow-up-circle" class="w-6 h-6"></i>
                            </button>
                            <input type="file" id="import-file-input" accept=".json" class="hidden" onchange="handleImport(event)" />
                            <button onclick="handleExport()" title="导出 JSON" class="btn-icon p-3 rounded-full bg-white dark:bg-slate-800 hover:bg-indigo-50 dark:hover:bg-slate-700 shadow-lg border border-white/10 text-indigo-600 dark:text-indigo-400">
                                <i data-lucide="arrow-down-circle" class="w-6 h-6"></i>
                            </button>
                            <button onclick="openAddModal()" class="btn-icon flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-2xl text-base font-bold shadow-lg shadow-indigo-500/30 border border-indigo-500/50">
                                <i data-lucide="plus" class="w-5 h-5"></i><span>添加</span>
                            </button>
                        </div>
                    </header>
                    <div class="app-layout">
                        <main class="golden-ratio-main p-6 custom-scrollbar relative">
                            <div id="filters-container" class="flex gap-3 mb-6 overflow-x-auto pb-2 scrollbar-hide"></div>
                            <div id="cards-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 pb-24"></div>
                        </main>
                        <aside class="sidebar-container glass-sidebar shadow-2xl z-10 flex flex-col" id="sidebar-area"></aside>
                    </div>
                `;
            }

            renderThemeMenu();
            
            // Render Filters
            const renderFilterBtn = (mode, label, icon, toggle) => {
                const isActive = toggle ? (state.sortMode.startsWith(mode)) : state.sortMode === mode;
                let arrow = '';
                if (toggle && isActive) arrow = state.sortMode.endsWith('asc') ? 'arrow-up' : 'arrow-down';
                const activeClass = 'bg-white dark:bg-slate-800 border-indigo-200 dark:border-indigo-900 text-indigo-600 dark:text-indigo-400 shadow-md';
                const inactiveClass = 'glass-card border-transparent text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50';
                return `<button onclick="setSortMode('${mode}')" class="btn-icon flex items-center gap-2 px-5 py-2.5 rounded-2xl text-sm font-bold border transition-all whitespace-nowrap ${isActive ? activeClass : inactiveClass}"><i data-lucide="${icon}" class="w-4 h-4"></i><span>${label}</span>${arrow ? `<i data-lucide="${arrow}" class="w-3 h-3"></i>` : ''}</button>`;
            };
            document.getElementById('filters-container').innerHTML = `
                ${renderFilterBtn('default', '默认', 'filter', false)}
                ${renderFilterBtn('alpha', '名称', 'align-left', true)}
                ${renderFilterBtn('danbooru', '热度', 'layers', true)}
                <div class="border-l border-slate-300 dark:border-slate-600 mx-2 h-6 self-center"></div>
                ${renderFilterBtn('favorite', '收藏', 'heart', false)}
            `;

            renderArtistCards();
            renderSelectionArea();
            renderModals();
            lucide.createIcons();
            applyTheme();
        };

        const renderThemeMenu = () => {
            const menu = document.getElementById('theme-menu');
            if (!menu) return;
            
            if (state.showThemeMenu) {
                menu.className = "absolute right-0 top-full mt-4 w-48 bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl border border-white/60 dark:border-slate-700 rounded-2xl shadow-2xl z-50 overflow-hidden animate-fade-in p-2 flex flex-col gap-1";
                menu.innerHTML = Object.keys(themes).map(key => `
                    <button onclick="setTheme('${key}')" class="flex items-center gap-3 px-3 py-2 rounded-xl text-sm font-medium transition-colors ${state.theme === key ? 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300' : 'text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700/50'}">
                        <i data-lucide="${themes[key].icon}" class="w-4 h-4"></i>
                        ${themes[key].name}
                    </button>
                `).join('');
                
                const closeHandler = (e) => {
                    if (!e.target.closest('.relative')) {
                        updateState({ showThemeMenu: false });
                        document.removeEventListener('click', closeHandler);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeHandler), 0);
            } else {
                menu.className = "hidden";
                menu.innerHTML = "";
            }
            lucide.createIcons(menu);
        };

        const renderArtistCards = () => {
            const container = document.getElementById('cards-container');
            if (!container) return;
            let list = state.liveArtists.filter(a => 
                a.name.toLowerCase().includes(state.searchQuery.toLowerCase()) || 
                a.tag.toLowerCase().includes(state.searchQuery.toLowerCase())
            );
            if (state.sortMode === 'favorite') list = list.filter(a => a.isFavorite);
            const sm = state.sortMode;
            if (sm === 'alpha-asc') list.sort((a,b) => a.name.localeCompare(b.name));
            else if (sm === 'alpha-desc') list.sort((a,b) => b.name.localeCompare(a.name));
            else if (sm === 'danbooru-desc') list.sort((a,b) => b.danbooruCount - a.danbooruCount);
            else if (sm === 'danbooru-asc') list.sort((a,b) => a.danbooruCount - b.danbooruCount);
            else if (sm === 'favorite') list.sort((a,b) => a.name.localeCompare(b.name));
            else list.sort((a,b) => b.createdAt - a.createdAt);

            if (list.length === 0 && !state.isDataLoading) {
                container.innerHTML = `<div class="col-span-full text-center py-32 text-slate-400 dark:text-slate-500"><i data-lucide="search-x" class="w-16 h-16 mb-4 mx-auto opacity-50"></i><p class="text-xl font-medium">未找到相关画师</p></div>`;
                return;
            }

            container.innerHTML = list.map(artist => {
                const isSel = !!state.selectedArtists[artist.id];
                return `
                <div onclick="toggleSelection('${artist.id}')" class="group relative glass-card rounded-3xl overflow-hidden cursor-pointer hover:-translate-y-2 transition-all duration-300 bg-white/40 dark:bg-slate-800/40 ${isSel ? 'ring-4 ring-indigo-500 dark:ring-indigo-400 shadow-2xl scale-[1.02]' : 'hover:shadow-xl dark:border-white/5'}">
                    <div class="aspect-[3/4] bg-slate-100 dark:bg-slate-700/50 relative overflow-hidden">
                        ${artist.imageUrl 
                            ? `<img src="${artist.imageUrl}" class="w-full h-full object-cover transition-all duration-500 group-hover:scale-110 ${artist.isNSFW && state.displayConfig?.blurNSFW !== false ? 'blur-xl group-hover:blur-none' : ''}" loading="lazy" />` 
                            : `<div class="w-full h-full flex items-center justify-center text-slate-300 dark:text-slate-600"><i data-lucide="image" class="w-12 h-12"></i></div>`
                        }
                        ${artist.isNSFW ? `<div class="absolute bottom-3 left-3 px-2.5 py-1 bg-red-500/90 backdrop-blur-sm text-white text-xs font-bold rounded-lg shadow-lg z-20 flex items-center gap-1"><i data-lucide="eye-off" class="w-3 h-3"></i>NSFW</div>` : ''}
                        ${isSel ? `<div class="absolute inset-0 bg-indigo-500/20 dark:bg-indigo-400/20 z-10 animate-fade-in flex items-center justify-center"><div class="bg-white dark:bg-slate-900 rounded-full p-2 shadow-lg"><i data-lucide="check" class="w-6 h-6 text-indigo-600 dark:text-indigo-400"></i></div></div>` : ''}
                        <div class="absolute top-3 right-3 flex flex-col gap-2 translate-x-14 opacity-0 group-hover:translate-x-0 group-hover:opacity-100 transition-all duration-300 z-30">
                             <button onclick="copyTag('${artist.id}', event)" class="btn-icon p-2.5 bg-white/90 dark:bg-slate-800/90 text-indigo-600 dark:text-indigo-400 rounded-full backdrop-blur-md shadow-lg hover:bg-indigo-50 dark:hover:bg-slate-700" title="复制 Tag"><i data-lucide="copy" class="w-5 h-5"></i></button>
                             <button onclick="handleCardAction('${artist.id}', 'preview', event)" class="btn-icon p-2.5 bg-white/90 dark:bg-slate-800/90 text-slate-700 dark:text-slate-200 rounded-full backdrop-blur-md shadow-lg hover:bg-indigo-50 dark:hover:bg-slate-700" title="预览"><i data-lucide="eye" class="w-5 h-5"></i></button>
                             <button onclick="handleCardAction('${artist.id}', 'edit', event)" class="btn-icon p-2.5 bg-white/90 dark:bg-slate-800/90 text-slate-700 dark:text-slate-200 rounded-full backdrop-blur-md shadow-lg hover:bg-indigo-50 dark:hover:bg-slate-700" title="编辑"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                             <button onclick="handleCardAction('${artist.id}', 'delete', event)" class="btn-icon p-2.5 bg-white/90 dark:bg-slate-800/90 text-red-500 dark:text-red-400 rounded-full backdrop-blur-md shadow-lg hover:bg-red-50 dark:hover:bg-red-900/30" title="删除"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                        <button onclick="toggleFavorite('${artist.id}', event)" class="btn-icon absolute top-3 left-3 p-2.5 rounded-full ${artist.isFavorite ? 'bg-white/90 dark:bg-slate-800/90 text-pink-500 shadow-md' : 'bg-black/20 text-white/70 hover:bg-white/90 hover:text-pink-400'} backdrop-blur-sm transition-all z-30"><i data-lucide="heart" class="w-5 h-5 ${artist.isFavorite ? 'fill-current' : ''}"></i></button>
                    </div>
                    <div class="p-5 absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent backdrop-blur-sm ${state.displayConfig?.showCardInfo ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0'} transition-all duration-300">
                        <h3 class="font-bold text-white text-lg truncate tracking-tight drop-shadow-lg">${artist.name}</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-sm text-white/90 font-mono truncate max-w-[60%] drop-shadow">${artist.tag}</span>
                            ${artist.danbooruCount > 0 ? `<span class="text-xs font-bold bg-white/20 text-white px-2 py-1 rounded-lg flex items-center gap-1 backdrop-blur-sm"><i data-lucide="layers" class="w-3 h-3"></i>${artist.danbooruCount}</span>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons(container);
        };

        const renderSelectionArea = () => {
            const container = document.getElementById('sidebar-area');
            if (!container) return;
            const list = getSelectedList();
            container.innerHTML = `
                <div class="p-6 border-b border-white/20 dark:border-slate-700/50 flex items-center justify-between flex-shrink-0">
                    <h2 class="font-bold text-xl text-slate-800 dark:text-white flex items-center gap-3"><span class="w-3 h-8 bg-indigo-500 rounded-full shadow-lg shadow-indigo-500/40"></span> 生成器</h2>
                    <span class="text-sm font-bold bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-300 px-3 py-1 rounded-full shadow-sm border border-indigo-100 dark:border-slate-600">${list.length}</span>
                </div>
                <div class="flex-1 overflow-y-auto p-5 space-y-3 custom-scrollbar">
                    ${list.length === 0 ? `<div class="h-full flex flex-col items-center justify-center text-slate-400 dark:text-slate-500 opacity-60"><i data-lucide="sparkles" class="w-12 h-12 mb-4"></i><p class="text-lg">点击左侧卡片</p><p class="text-sm">组合你的 Prompt</p></div>` : list.map(a => `
                        <div class="flex items-center justify-between glass-card bg-white/60 dark:bg-slate-800/60 p-3 rounded-2xl group hover:border-indigo-300 dark:hover:border-indigo-700 transition-all">
                            <div class="flex items-center gap-3 min-w-0 flex-1">
                                <div class="w-12 h-12 rounded-xl bg-slate-200 dark:bg-slate-700 overflow-hidden flex-shrink-0 shadow-sm">${a.imageUrl ? `<img src="${a.imageUrl}" class="w-full h-full object-cover"/>` : ''}</div>
                                <div class="min-w-0"><p class="text-sm font-bold text-slate-700 dark:text-slate-200 truncate">${a.name}</p><p class="text-xs text-slate-500 dark:text-slate-400 font-mono truncate opacity-80">${a.tag}</p></div>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <div class="bg-white dark:bg-slate-900 border border-indigo-100 dark:border-slate-700 px-2 py-1 rounded-lg text-sm font-bold text-indigo-600 dark:text-indigo-400 font-mono w-12 text-center">${a.weight.toFixed(1)}</div>
                                <div class="flex flex-col gap-1">
                                    <button onclick="updateArtistWeight('${a.id}', 0.1, event)" class="p-0.5 bg-white dark:bg-slate-700 hover:bg-indigo-50 dark:hover:bg-slate-600 rounded-md text-slate-600 dark:text-slate-300 transition-colors"><i data-lucide="chevron-up" class="w-3 h-3"></i></button>
                                    <button onclick="updateArtistWeight('${a.id}', -0.1, event)" class="p-0.5 bg-white dark:bg-slate-700 hover:bg-indigo-50 dark:hover:bg-slate-600 rounded-md text-slate-600 dark:text-slate-300 transition-colors"><i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                            <button onclick="toggleSelection('${a.id}')" class="p-2.5 ml-1 text-slate-400 hover:text-red-500 dark:text-slate-500 dark:hover:text-red-400 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    `).join('')}
                </div>
                <div class="p-6 border-t border-white/20 dark:border-slate-700/50 flex-shrink-0 bg-white/30 dark:bg-slate-900/30">
                    <div class="bg-white/80 dark:bg-slate-800/80 border border-indigo-100 dark:border-slate-700 rounded-2xl p-4 mb-4 max-h-40 overflow-y-auto text-sm font-mono text-slate-700 dark:text-slate-300 break-words leading-relaxed shadow-inner custom-scrollbar">
                        ${list.map(a => a.weight === 1 ? a.tag : `(${a.tag}:${a.weight.toFixed(1)})`).join(', ') || '<span class="text-slate-400 italic">等待选择...</span>'}
                    </div>
                    <div class="grid grid-cols-4 gap-3">
                        <button onclick="clearSelection()" class="btn-icon col-span-1 py-3.5 flex justify-center items-center bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm hover:text-red-500 hover:border-red-200 dark:hover:border-red-900"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        <button onclick="copyPrompts()" class="${list.length === 0 ? 'opacity-50 cursor-not-allowed' : ''} btn-icon col-span-3 py-3.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl font-bold shadow-lg flex justify-center items-center gap-2 hover:bg-slate-800 dark:hover:bg-indigo-50"><i data-lucide="copy" class="w-5 h-5"></i> 复制咒语</button>
                    </div>
                </div>
            `;
            lucide.createIcons(container);
        };

        const renderModals = () => {
            const container = document.getElementById('modal-container');
            const aiContainer = document.getElementById('ai-settings-container');
            const previewContainer = document.getElementById('preview-modal-container');

            // Render AI Settings Modal
            if (state.isAISettingsOpen) {
                const config = state.aiConfig || {};
                const displayConfig = state.displayConfig || { showCardInfo: false };
                aiContainer.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; z-index: 60; padding: 1rem;" class="animate-fade-in">
                        <div class="absolute inset-0 bg-slate-900/30 dark:bg-black/60 backdrop-blur-md" onclick="closeAISettings()"></div> 
                        <div class="glass-modal dark:bg-slate-900/95 rounded-[2rem] shadow-2xl p-8 relative z-20 w-full max-w-md border dark:border-slate-700">
                            <button onclick="closeAISettings()" class="absolute top-6 right-6 p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-3"><span class="w-2 h-8 bg-indigo-500 rounded-full"></span>设置</h2>
                            
                            <div class="mb-6">
                                <h3 class="text-sm font-bold text-slate-600 dark:text-slate-300 mb-3 flex items-center gap-2"><i data-lucide="layout-grid" class="w-4 h-4"></i>显示设置</h3>
                                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-2xl p-4 border border-slate-200 dark:border-slate-700 space-y-3">
                                    <label class="flex items-center justify-between cursor-pointer">
                                        <div>
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-200">始终显示卡片信息</span>
                                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">关闭后仅在悬停时显示</p>
                                        </div>
                                        <input type="checkbox" id="show-card-info-toggle" ${displayConfig.showCardInfo ? 'checked' : ''} class="w-12 h-6 appearance-none bg-slate-300 dark:bg-slate-600 rounded-full relative cursor-pointer transition-colors checked:bg-indigo-500 dark:checked:bg-indigo-400 before:content-[''] before:absolute before:w-5 before:h-5 before:bg-white before:rounded-full before:top-0.5 before:left-0.5 before:transition-transform checked:before:translate-x-6">
                                    </label>
                                    <div class="h-px bg-slate-200 dark:bg-slate-700"></div>
                                    <label class="flex items-center justify-between cursor-pointer">
                                        <div>
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-200">模糊 NSFW 内容</span>
                                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">悬停可查看完整图片</p>
                                        </div>
                                        <input type="checkbox" id="blur-nsfw-toggle" ${displayConfig.blurNSFW !== false ? 'checked' : ''} class="w-12 h-6 appearance-none bg-slate-300 dark:bg-slate-600 rounded-full relative cursor-pointer transition-colors checked:bg-indigo-500 dark:checked:bg-indigo-400 before:content-[''] before:absolute before:w-5 before:h-5 before:bg-white before:rounded-full before:top-0.5 before:left-0.5 before:transition-transform checked:before:translate-x-6">
                                    </label>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="text-sm font-bold text-slate-600 dark:text-slate-300 mb-3 flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i>AI 分析配置</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">API Host</label>
                                        <input type="text" id="ai-host-input" value="${config.apiHost || 'https://api.openai.com/v1'}" class="w-full px-5 py-3 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500/50 outline-none transition-all text-sm shadow-sm" placeholder="https://api.openai.com/v1">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">API Key</label>
                                        <input type="password" id="ai-key-input" value="${config.apiKey || ''}" class="w-full px-5 py-3 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500/50 outline-none transition-all text-sm shadow-sm" placeholder="sk-...">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">模型名称 (Model)</label>
                                        <input type="text" id="ai-model-input" value="${config.model || 'gpt-4o'}" class="w-full px-5 py-3 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500/50 outline-none transition-all text-sm shadow-sm" placeholder="gpt-4o">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-8 flex gap-4">
                                <button onclick="closeAISettings()" class="flex-1 py-3 rounded-2xl text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-sm">取消</button>
                                <button onclick="saveAISettings()" class="flex-1 py-3 rounded-2xl bg-indigo-600 text-white font-bold shadow-xl hover:bg-indigo-500 hover:shadow-indigo-500/40 transition-all text-sm">保存设置</button>
                            </div>
                        </div>
                    </div>`;
                lucide.createIcons(aiContainer);
            } else {
                aiContainer.innerHTML = '';
            }

            // Render Artist Modal (Independent of AI Settings)
            if (state.isModalOpen) {
                container.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem;" class="animate-fade-in">
                        <div class="absolute inset-0 bg-slate-900/30 dark:bg-black/60 backdrop-blur-md" onclick="handleCloseModal()"></div>
                        <div class="glass-modal dark:bg-slate-900/95 rounded-[2rem] shadow-2xl p-8 relative z-10 w-full max-w-lg border dark:border-slate-700">
                            <button onclick="handleCloseModal()" class="absolute top-6 right-6 p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-8 flex items-center gap-3"><span class="w-2 h-8 bg-indigo-500 rounded-full"></span>${state.editingArtist ? '编辑画师' : '添加新画师'}</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">显示名称 (Name)</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="modal-artist-name" value="${state.formData.name}" oninput="handleModalFormInput('name', this.value)" class="flex-1 px-5 py-3.5 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500/50 outline-none transition-all text-base shadow-sm" placeholder="例如: Mika Pikazo">
                                        <button id="analyze-btn" onclick="analyzeArtistStyle()" title="AI 分析画风 (6字总结)" class="px-4 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-2xl hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors flex items-center justify-center border border-indigo-200 dark:border-indigo-800/50 shadow-sm">
                                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                <div><label class="block text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">Tag (必填)</label><input type="text" value="${state.formData.tag}" oninput="handleModalFormInput('tag', this.value)" class="w-full px-5 py-3.5 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500/50 outline-none transition-all font-mono text-base shadow-sm" placeholder="例如: mika pikazo"></div>
                                <div><label class="block text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2 flex items-center gap-2">Danbooru 数据量 <i data-lucide="layers" class='w-3 h-3'></i></label><input type="number" value="${state.formData.danbooruCount}" oninput="handleModalFormInput('danbooruCount', this.value)" class="w-full px-5 py-3.5 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white outline-none shadow-sm" placeholder="0"></div>
                                <div>
                                    <label class="flex items-center gap-3 cursor-pointer bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-red-300 dark:hover:border-red-800 transition-colors">
                                        <input type="checkbox" ${state.formData.isNSFW ? 'checked' : ''} onchange="handleModalFormInput('isNSFW', this.checked)" class="w-5 h-5 text-red-500 bg-slate-100 border-slate-300 rounded focus:ring-red-500 dark:focus:ring-red-600 dark:ring-offset-slate-800 focus:ring-2 dark:bg-slate-700 dark:border-slate-600">
                                        <div class="flex-1">
                                            <span class="text-sm font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><i data-lucide="eye-off" class="w-4 h-4 text-red-500"></i>NSFW 内容</span>
                                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">标记后图片将被模糊处理</p>
                                        </div>
                                    </label>
                                </div>
                                <div><label class="block text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-3">卡片封面图 (点击上传)</label><div id="image-upload-container"></div><input type="file" id="modal-file-input" class="hidden" accept="image/*" onchange="handleModalFileSelect(event)"></div>
                            </div>
                            <div class="mt-10 flex gap-4">
                                <button onclick="handleCloseModal()" class="flex-1 py-3.5 rounded-2xl text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-base">取消</button>
                                <button id="modal-save-btn" onclick="handleSaveArtist()" class="btn-icon flex-1 py-3.5 rounded-2xl bg-indigo-600 text-white font-bold shadow-xl hover:bg-indigo-500 hover:shadow-indigo-500/40 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-base" ${!state.formData.tag.trim() ? 'disabled' : ''}>保存更改</button>
                            </div>
                        </div>
                    </div>`;
                updateModalImagePreviewDOM(); 
            } else {
                container.innerHTML = '';
            }

            if (state.previewImage) {
                previewContainer.innerHTML = `
                    <div class="fixed inset-0 z-[80] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 animate-fade-in" onclick="closePreview()">
                        <button onclick="closePreview()" class="absolute top-6 right-6 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full transition-all z-50"><i data-lucide="x" class="w-8 h-8"></i></button>
                        <div class="relative max-w-5xl max-h-full w-full flex items-center justify-center" onclick="event.stopPropagation()"><img src="${state.previewImage}" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" /></div>
                    </div>`;
            } else {
                previewContainer.innerHTML = '';
            }
            lucide.createIcons();
        };

        (async () => {
            updateState({ isDataLoading: true });
            applyTheme();
            try {
                const savedMeta = localStorage.getItem(METADATA_KEY);
                const meta = savedMeta ? JSON.parse(savedMeta) : INITIAL_DATA;
                const imgMap = await getAllImagesFromIDB().catch(() => ({}));
                const merged = meta.map(a => ({ ...a, imageUrl: imgMap[a.id] || a.imageUrl || '', isNSFW: a.isNSFW || false }));
                updateState({ liveArtists: merged, isDataLoading: false });
            } catch (e) {
                updateState({ liveArtists: INITIAL_DATA, isDataLoading: false });
            }
        })();
    </script>
</body>
</html>